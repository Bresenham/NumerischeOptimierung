\documentclass[a4paper, 12pt]{report}
\usepackage{graphicx}
\usepackage[utf8]{inputenc}
\usepackage[ngerman]{babel}
\usepackage{geometry}
\usepackage{csquotes}
\usepackage[toc,page]{appendix}
\usepackage{titlesec}
\usepackage{listings}
\usepackage{float}
\usepackage[hang,flushmargin]{footmisc} 
\usepackage{makecell}
\usepackage{amsmath}% http://ctan.org/pkg/amsmath
\usepackage[utf8]{inputenc}
\usepackage[default]{cantarell} %% Use option "defaultsans" to use cantarell as sans serif only
\usepackage[T1]{fontenc}
\usepackage{hyperref}
\usepackage{helvet}
\usepackage[eulergreek]{sansmath}
\usepackage{amsfonts}
\usepackage{movie15}
\usepackage{url}
\usepackage{lscape}

\usepackage{tikz}
\usetikzlibrary{calc,positioning,shapes,decorations.pathreplacing}
\usetikzlibrary{fit,fadings,shadows,patterns,math}
\usetikzlibrary{shapes.arrows,shapes.geometric}
\usetikzlibrary{arrows,arrows.meta,decorations.markings}
\usetikzlibrary{decorations.pathmorphing}

\usepackage{pgfplots}

\graphicspath{ {./images/} }
\geometry{margin=1.25in}

\newcommand*{\shifttext}[2]{%
  \settowidth{\@tempdima}{#2}%
  \makebox[\@tempdima]{\hspace*{#1}#2}%
}
\newcommand{\fakesection}[1]{%
  \par\refstepcounter{section}% Increase section counter
  \sectionmark{#1}% Add section mark (header)
  \addcontentsline{toc}{section}{\protect\numberline{\thesection}#1}% Add section to ToC
  % Add more content here, if needed.
}
\titleformat{\chapter}[display]
  {\normalfont\bfseries}{}{0pt}{\Large}
\titleformat*{\section}{\large\bfseries}

\renewcommand{\footnoterule}{%
  \kern -3pt
  \hrule width \textwidth height 1pt
  \kern 2pt
}

\newcommand\blfootnote[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

\begin{document}

\begin{center}
    \vspace*{2em}
    \normalsize 2. Projekt\\
    \vspace*{1em}
    \normalsize \textbf{\textit{Quasi-Newton-Verfahren \& Gauß-Newton-Verfahren}}\\
    \vspace*{4em}
    \normalsize im Fach\\
    \vspace*{1em}
    \large Numerische Optimierung\\
    \vspace*{30em}
    \normalsize Juni 2020\\
    \vspace*{1em}
    \normalsize Maximilian Gaul
\end{center}

\thispagestyle{empty}

\newpage

\subsubsection{Aufgabe 1}
Siehe Programmcode in \lstinline[basicstyle=\ttfamily\color{black}]|Project2.m|.

\newpage

\newgeometry{margin=0.25in}
\begin{landscape}
\subsubsection{Aufgabe 2}
$$\scriptscriptstyle I - \frac{s(As)^T}{s^TAs} + \frac{A^{-1}yy^T}{y^Ts} + \frac{(s - A^{-1}y)s^TA + s(s - A^{-1}y)^TA}{y^Ts} - \frac{(s - A^{-1}y)s^TAs(As)^T + s(s - A^{-1}y)^TAs(As)^T}{y^Tss^TAs} + \frac{(s - A^{-1}y)s^Tyy^T + s(s - A^{-1}y)^Tyy^T}{(y^Ts)^2} - \frac{(s - A^{-1}y)^Tyss^TA}{(y^Ts)^2} + \frac{(s - A^{-1}y)^Tyss^TAs(As)^T}{(y^Ts)^2s^TAs} - \frac{(s - A^{-1}y)^Tyss^Tyy^T}{(y^Ts)^2y^Ts}$$
$$\scriptscriptstyle I - \frac{ss^TA}{s^TAs} + \frac{A^{-1}yy^T}{y^Ts} + \frac{ss^TA - A^{-1}ys^TA + s(s^T - (A^{-1}y)^T)A}{y^Ts} - \frac{ss^TAss^TA - A^{-1}ys^TAss^TA + s(s^T - (A^{-1}y)^T)Ass^TA}{y^Tss^TAs} + \frac{ss^Tyy^T - A^{-1}ys^Tyy^T + s(s^T - (A^{-1}y)^T)yy^T}{(y^Ts)^2} -\frac{(s^T - (A^{-1}y)^T)yss^TA}{(y^Ts)^2} + \frac{(s^T - (A^{-1}y)^T)yss^TAss^TA}{(y^Ts)^2s^TAs} - \frac{(s^T - (A^{-1}y)^T)yss^Tyy^T}{(y^Ts)^2y^Ts} $$
$$\scriptscriptstyle I - \frac{ss^TA}{s^TAs} + \frac{A^{-1}yy^T}{y^Ts} + \frac{2ss^TA - A^{-1}ys^TA - sy^T}{y^Ts} - \frac{2ss^TA - A^{-1}ys^TA - sy^T}{y^Tss^TAs}\cdot ss^TA + \frac{2ss^T - A^{-1}ys^T - sy^T(A^{-1})^T}{(y^Ts)^2}\cdot yy^T -\frac{s^Ty - y^T(A^{-1})^T}{(y^Ts)^2}\cdot ss^TA + \frac{(s^T - y^T(A^{-1})^T)yss^TAss^TA}{(y^Ts)^2s^TAs} - \frac{(s^T - y^T(A^{-1})^T)yss^Tyy^T}{(y^Ts)^2y^Ts} $$
\end{landscape}
\restoregeometry

\newpage

\subsubsection{Aufgabe 3}
Wenn die Suchrichtung des BFGS Verfahrens:

$$d = -B\cdot \nabla f(x) $$

keine Abstiegsrichtung ist, d.h. die Bedingung:

$$\nabla f(x)^T \cdot d < 0 $$

nicht erfüllt ist, muss das Verfahren 'resettet' werden. In diesem Fall bietet es sich an, die Suchrichtung auf den
negativen Gradienten zu setzen:

$$d = -\nabla f(x)$$

Da nun die Abstiegsrichtung nicht mehr zur approximierten Inversen der Hesse-Matrix $B$ passt, muss diese ebenfalls für
den nächsten Schritt neu bestimmt werden. Hierzu bieten sich verschiedene Möglichkeiten an:

\begin{itemize}
  \item Wie beim Start des BFGS-Verfahrens $B = I$ setzen
  \begin{itemize}
    \item Hierbei geht jeglicher berechnete Fortschritt verloren, es handelt sich um einen recht naiven Ansatz
  \end{itemize}
  \item Die Hesse-Matrix einmalig aus Differenzenquotienten des Gradienten bestimmen und anschließend invertieren
  \begin{itemize}
    \item Hoher Rechenaufwand von $\mathcal{O}(n^2)$ für die Hesse-Matrix und nochmal $\mathcal{O}(n^3)$ für das Invertieren
    \item Bisher berechneter Fortschritt geht ebenfalls verloren aber die Approximation der Hesse-Matrix ist sehr genau
  \end{itemize}
  \item Man könnte, wie in den Vorlesungsfolien beschrieben,  $\frac{y^Ts}{y^Ty}\cdot I_n$ als positiv-definitve Matrix verwenden
\end{itemize}

Um herauszufinden, welche dieser Methoden am besten geeignet ist (d.h. die richtig Lösung in der kürzesten Zeit findet),
wird die Laufzeit des inversen BFGS-Verfahrens bestimmt. Startwerte:

\begin{itemize}
  \item N-dim. Rosenbrock-Funktion: $\begin{bmatrix}-1\\\vdots\\-1\end{bmatrix}$
  \item Himmelblau-Funktion: $\begin{bmatrix}0\\-1\end{bmatrix}$
  \item Bazaraa-Shetty: $\begin{bmatrix}0\\-1\end{bmatrix}$
\end{itemize}

\begin{figure}[H]
  \centering
  \pgfplotstableread{
    0 0.2240  0.0030  0.0051
  }\dataseth
  \pgfplotstableread{
    0 0.1904  0.0023  0.0043
  }\datasetf
  \pgfplotstableread{
    0 0.0       16.337017     3.398372
  }\datasetg
  \begin{minipage}{.3\textwidth}
    \begin{tikzpicture}
        \pgfplotsset{
          tick label style = {font=\sansmath\sffamily},
          every axis label = {font=\sansmath\sffamily},
          legend style = {font=\sansmath\sffamily},
          label style = {font=\sansmath\sffamily}
        }
        \begin{axis}[
            width=4cm,
            height=6.5cm,
            ybar,
            ymin=0,
            ymax=0.25,
            ylabel={Rechenzeit in s},
            ylabel style={xshift=-3ex},
            ytick distance=0.1,
            % ytick=\empty,
            % extra y ticks={0,0.05,0.10,0.15,0.2,0.25},
            % extra y tick labels={{0},{0.05},{0.10},{0.15},{0.2},{0.25}},
            xtick=data,
            xticklabels={
                $B = I$
            },
            yticklabel style={xshift=0ex},
            xticklabel style={yshift=-16ex},
            major x tick style={
                % (this is a better way than assigning `opacity=0')
                /pgfplots/major tick length=0pt,
            },
            minor x tick num=1,
            minor tick length=2ex,
            % ---------------------------------------------------------------------
            % (adapted solution from <https://tex.stackexchange.com/a/141006/95441>)
            % we want to provide absolute `at' values ...
            scatter/position=absolute,
            node near coords style={
                % ... to provide axis coordinates at `ymin' for the nodes
                at={(axis cs:\pgfkeysvalueof{/data point/x},\pgfkeysvalueof{/pgfplots/ymin})},
                % then also the `anchor' has to be adapted ...
                anchor=east,
                % ... because we rotate the labels which would overlap otherwise
                rotate=90,
            },
            % ---------------------------------------------------------------------
            % (created a cycle list to shorten the below `\addplot' entries)
            cycle list={
                {draw=black,fill=black!20},
                {draw=black,fill=black!40},
                {draw=black,fill=black!60},
            },
            % (moved common option here)
            table/x index=0,
        ]
            \addplot+ [nodes near coords=200-dim. Rosen.] table [y index=1] \dataseth;
            \addplot+ [nodes near coords=Himmelblau] table [y index=2] \dataseth;
            \addplot+ [nodes near coords=Bazaraa-Shetty] table [y index=3] \dataseth;
        \end{axis}
        \node[black, rotate=90, align=left] (impl) at (1.2125,1.08) {0.0030};
        \draw[-{Latex}, thick, black] (impl.west) -- ([yshift=-0.2cm]impl.west);

        \node[black, rotate=90, align=left] (impl2) at (1.6255,1.124) {0.0051};
        \draw[-{Latex}, thick, black] (impl2.west) -- ([yshift=-0.2cm]impl2.west);
    \end{tikzpicture}
  \end{minipage}
  \begin{minipage}{.3\textwidth}
    \begin{tikzpicture}
      \pgfplotsset{
        tick label style = {font=\sansmath\sffamily},
        every axis label = {font=\sansmath\sffamily},
        legend style = {font=\sansmath\sffamily},
        label style = {font=\sansmath\sffamily}
      }
        \begin{axis}[
            width=4cm,
            height=6.5cm,
            ybar,
            ymin=0,
            ymax=0.25,
            % ytick=\empty,
            % extra y ticks={0,0.05,0.10,0.15,0.2,0.25},
            % extra y tick labels={{0},{0.05},{0.10},{0.15},{0.2},{0.25}},
            xtick=data,
            xticklabels={
                $B = \frac{y^Ts}{y^Ty}\cdot I$
            },
            xticklabel style={yshift=-16ex},
            major x tick style={
                % (this is a better way than assigning `opacity=0')
                /pgfplots/major tick length=0pt,
            },
            minor x tick num=1,
            minor tick length=2ex,
            % ---------------------------------------------------------------------
            % (adapted solution from <https://tex.stackexchange.com/a/141006/95441>)
            % we want to provide absolute `at' values ...
            scatter/position=absolute,
            node near coords style={
                % ... to provide axis coordinates at `ymin' for the nodes
                at={(axis cs:\pgfkeysvalueof{/data point/x},\pgfkeysvalueof{/pgfplots/ymin})},
                % then also the `anchor' has to be adapted ...
                anchor=east,
                % ... because we rotate the labels which would overlap otherwise
                rotate=90,
            },
            % ---------------------------------------------------------------------
            % (created a cycle list to shorten the below `\addplot' entries)
            cycle list={
              {draw=black,fill=black!20},
              {draw=black,fill=black!40},
              {draw=black,fill=black!60},
            },
            % (moved common option here)
            table/x index=0,
        ]
        \addplot+ [nodes near coords=200-dim. Rosen.] table [y index=1] \datasetf;
        \addplot+ [nodes near coords=Himmelblau] table [y index=2] \datasetf;
        \addplot+ [nodes near coords=Bazaraa-Shetty] table [y index=3] \datasetf;
        \end{axis}
        \node[black, rotate=90, align=left] (impl) at (1.2125,1.055) {0.0023};
        \draw[-{Latex}, thick, black] (impl.west) -- ([yshift=-0.2cm]impl.west);

        \node[black, rotate=90, align=left] (impl2) at (1.6255,1.1) {0.0043};
        \draw[-{Latex}, thick, black] (impl2.west) -- ([yshift=-0.2cm]impl2.west);
    \end{tikzpicture}
  \end{minipage}
  \begin{minipage}{.3\textwidth}
    \begin{tikzpicture}
        \begin{axis}[
            width=4cm,
            height=6.5cm,
            ybar,
            ymin=0,
            ytick=\empty,
            extra y ticks={0,5,10,15,20,25},
            extra y tick labels={{0},{5},{10},{15},{20},{25}},
            xtick=data,
            xticklabels={
                Diff. Quot.
            },
            xticklabel style={yshift=-16ex},
            major x tick style={
                % (this is a better way than assigning `opacity=0')
                /pgfplots/major tick length=0pt,
            },
            minor x tick num=1,
            minor tick length=2ex,
            % ---------------------------------------------------------------------
            % (adapted solution from <https://tex.stackexchange.com/a/141006/95441>)
            % we want to provide absolute `at' values ...
            scatter/position=absolute,
            node near coords style={
                % ... to provide axis coordinates at `ymin' for the nodes
                at={(axis cs:\pgfkeysvalueof{/data point/x},\pgfkeysvalueof{/pgfplots/ymin})},
                % then also the `anchor' has to be adapted ...
                anchor=east,
                % ... because we rotate the labels which would overlap otherwise
                rotate=90,
            },
            % ---------------------------------------------------------------------
            % (created a cycle list to shorten the below `\addplot' entries)
            cycle list={
                {draw=black,fill=black!40},
                {draw=black,fill=black!60},
            },
            % (moved common option here)
            table/x index=0,
        ]
        \addplot+ [nodes near coords=200-dim. Rosen.] table [y index=1] \datasetg;
        \addplot+ [nodes near coords=Himmelblau] table [y index=2] \datasetg;
        \addplot+ [nodes near coords=Bazaraa-Shetty] table [y index=3] \datasetg;
        \end{axis}
    \end{tikzpicture}
  \end{minipage}
  \caption{Vergleich der Rechenzeit für eine Genauigkeit von $10^{-8}$ gemittelt über 100 Durchläufe (Intel Core i3-7100U, 8GB RAM, Windows 10 64-Bit)}
\end{figure}

Alle drei Funktionen profitieren von $B = \frac{y^Ts}{y^Ty}\cdot I$, daher habe ich diesen Weg in meiner Implementierung gewählt.

\subsubsection{Aufgabe 4}

\begin{figure}[H]
  \centering
  \begin{tikzpicture}
    \pgfplotsset{
      tick label style = {font=\sansmath\sffamily},
      every axis label = {font=\sansmath\sffamily},
      legend style = {font=\sansmath\sffamily},
      label style = {font=\sansmath\sffamily}
    }
    \pgfplotstableread[col sep=comma]{bfgs_ndim_rosen_measurement.csv}\datatable
    \begin{axis}[
        ybar,
        ymin=0,
        ymax=2,
        ytick distance=0.5,
        ylabel={Rechenzeit in s},
        xmin=0,
        xmax=500,
        xtick distance=50,
        xlabel={Dimension},
        height=4.5cm,
        width=\textwidth,
        tick align=inside
      ]
      \addplot[fill=black!40, draw=black] table[x index = {0}, y index = {1}] {\datatable};
    \end{axis}
  \end{tikzpicture}
  \caption{Rechenzeit der N-dimensionalen Rosenbrock-Funktion gemittelt über 100 Durchläufe}
\end{figure}

\end{document}